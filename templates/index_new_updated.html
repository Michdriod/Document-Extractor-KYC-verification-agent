<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Deprecated Template</title>
        <meta http-equiv="refresh" content="0; url=/" />
        <style>
            body { font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif; padding: 2rem; }
            .note { background:#fff3cd; color:#856404; padding:1rem; border:1px solid #ffeeba; border-radius:8px; }
        </style>
    </head>
    <body>
        <div class="note">
            <strong>This template is deprecated.</strong>
            Please use <code>templates/index_new.html</code>. Redirecting to the active UIâ€¦
        </div>
    </body>
</html>

                <!-- Tab Navigation -->
                <div class="border-b border-gray-200 mb-4">
                    <nav class="-mb-px flex space-x-8">
                        <a 
                            href="javascript:void(0)" 
                            @click="activeTab = 'structured'" 
                            class="px-1 py-3 border-b-2 text-sm font-medium" 
                            :class="activeTab === 'structured' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        >
                            Structured Data
                        </a>
                        <a 
                            href="javascript:void(0)" 
                            @click="activeTab = 'raw'" 
                            class="px-1 py-3 border-b-2 text-sm font-medium"
                            :class="activeTab === 'raw' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        >
                            Raw OCR
                        </a>
                    </nav>
                </div>

                <!-- Structured Data View -->
                <div x-show="activeTab === 'structured' && results?.structured_data" class="space-y-6">
                    <!-- Document Categories -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Personal Information -->
                        <div class="space-y-4">
                            <h4 class="font-medium text-gray-900 border-b pb-2">Personal Information</h4>
                            <div class="space-y-3">
                                <div x-show="getCurrentStructuredData()?.surname || getCurrentStructuredData()?.given_names">
                                    <label class="text-xs font-medium text-gray-500 uppercase tracking-wide">Full Name</label>
                                    <p class="mt-1 text-sm text-gray-900">
                                        <span x-text="getCurrentStructuredData()?.given_names?.value || ''"></span>
                                        <span x-text="getCurrentStructuredData()?.surname?.value || ''"></span>
                                    </p>
                                </div>
                                <div x-show="getCurrentStructuredData()?.date_of_birth">
                                    <label class="text-xs font-medium text-gray-500 uppercase tracking-wide">Date of Birth</label>
                                    <p class="mt-1 text-sm text-gray-900" x-text="getCurrentStructuredData()?.date_of_birth?.value"></p>
                                    <span class="text-xs text-gray-500" x-text="'Confidence: ' + Math.round((getCurrentStructuredData()?.date_of_birth?.confidence || 0) * 100) + '%'" ></span>
                                </div>
                                <div x-show="results.structured_data?.nationality">
                                    <label class="text-xs font-medium text-gray-500 uppercase tracking-wide">Nationality</label>
                                    <p class="mt-1 text-sm text-gray-900" x-text="results.structured_data?.nationality?.value"></p>
                                    <span class="text-xs text-gray-500" x-text="'Confidence: ' + Math.round((results.structured_data?.nationality?.confidence || 0) * 100) + '%'" ></span>
                                </div>
                                <div x-show="results.structured_data?.sex">
                                    <label class="text-xs font-medium text-gray-500 uppercase tracking-wide">Gender</label>
                                    <p class="mt-1 text-sm text-gray-900" x-text="results.structured_data?.sex?.value"></p>
                                    <span class="text-xs text-gray-500" x-text="'Confidence: ' + Math.round((results.structured_data?.sex?.confidence || 0) * 100) + '%'" ></span>
                                </div>
                            </div>
                        </div>

                        <!-- Document Dates -->
                        <div class="space-y-4">
                            <h4 class="font-medium text-gray-900 border-b pb-2">Document Validity</h4>
                            <div class="space-y-3">
                                <div x-show="results.structured_data?.date_of_issue">
                                    <label class="text-xs font-medium text-gray-500 uppercase tracking-wide">Issue Date</label>
                                    <p class="mt-1 text-sm text-gray-900" x-text="results.structured_data?.date_of_issue?.value"></p>
                                    <span class="text-xs text-gray-500" x-text="'Confidence: ' + Math.round((results.structured_data?.date_of_issue?.confidence || 0) * 100) + '%'" ></span>
                                </div>
                                <div x-show="results.structured_data?.date_of_expiry">
                                    <label class="text-xs font-medium text-gray-500 uppercase tracking-wide">Expiry Date</label>
                                    <p class="mt-1 text-sm text-gray-900" x-text="results.structured_data?.date_of_expiry?.value"></p>
                                    <span class="text-xs text-gray-500" x-text="'Confidence: ' + Math.round((results.structured_data?.date_of_expiry?.confidence || 0) * 100) + '%'" ></span>
                                </div>
                                <div x-show="results.structured_data?.issuing_authority">
                                    <label class="text-xs font-medium text-gray-500 uppercase tracking-wide">Issuing Authority</label>
                                    <p class="mt-1 text-sm text-gray-900" x-text="results.structured_data?.issuing_authority?.value"></p>
                                    <span class="text-xs text-gray-500" x-text="'Confidence: ' + Math.round((results.structured_data?.issuing_authority?.confidence || 0) * 100) + '%'" ></span>
                                </div>
                            </div>
                        </div>

                        <!-- Document-Specific Information -->
                        <div class="space-y-4" x-show="results.structured_data?.passport_type || results.structured_data?.license_class || results.structured_data?.mrz_lines || results.structured_data?.vehicle_categories || results.structured_data?.nin">
                            <h4 class="font-medium text-gray-900 border-b pb-2">Document-Specific Details</h4>
                            <div class="space-y-3">
                                <div x-show="results.structured_data?.document_number">
                                    <label class="text-xs font-medium text-gray-500 uppercase tracking-wide">Document Number</label>
                                    <p class="mt-1 text-sm text-gray-900" x-text="results.structured_data?.document_number?.value"></p>
                                    <span class="text-xs text-gray-500" x-text="'Confidence: ' + Math.round((results.structured_data?.document_number?.confidence || 0) * 100) + '%'" ></span>
                                </div>
                                <div x-show="results.structured_data?.passport_type">
                                    <label class="text-xs font-medium text-gray-500 uppercase tracking-wide">Passport Type</label>
                                    <p class="mt-1 text-sm text-gray-900" x-text="results.structured_data?.passport_type?.value"></p>
                                    <span class="text-xs text-gray-500" x-text="'Confidence: ' + Math.round((results.structured_data?.passport_type?.confidence || 0) * 100) + '%'" ></span>
                                </div>
                                <div x-show="results.structured_data?.license_class">
                                    <label class="text-xs font-medium text-gray-500 uppercase tracking-wide">License Class</label>
                                    <p class="mt-1 text-sm text-gray-900" x-text="results.structured_data?.license_class?.value"></p>
                                    <span class="text-xs text-gray-500" x-text="'Confidence: ' + Math.round((results.structured_data?.license_class?.confidence || 0) * 100) + '%'" ></span>
                                </div>
                                <div x-show="results.structured_data?.nin">
                                    <label class="text-xs font-medium text-gray-500 uppercase tracking-wide">National ID Number</label>
                                    <p class="mt-1 text-sm text-gray-900" x-text="results.structured_data?.nin?.value"></p>
                                    <span class="text-xs text-gray-500" x-text="'Confidence: ' + Math.round((results.structured_data?.nin?.confidence || 0) * 100) + '%'" ></span>
                                </div>
                                <div x-show="results.structured_data?.mrz_lines">
                                    <label class="text-xs font-medium text-gray-500 uppercase tracking-wide">MRZ Data</label>
                                    <pre class="mt-1 text-xs bg-gray-100 p-2 rounded" x-text="results.structured_data?.mrz_lines?.value"></pre>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Show message when no structured data -->
                    <div x-show="!results?.structured_data" class="text-center py-8">
                        <i class="fas fa-info-circle text-blue-500 text-2xl mb-3"></i>
                        <p class="text-gray-600">No structured data available. Try enabling "Extract Structured Data" option.</p>
                    </div>

                    <!-- Raw JSON View -->
                    <div x-show="results?.structured_data" class="mt-6">
                        <button 
                            @click="showRawJson = !showRawJson"
                            class="text-blue-600 hover:text-blue-800 text-sm font-medium"
                        >
                            <i class="fas fa-code mr-1"></i>
                            <span x-show="!showRawJson">Show Raw JSON</span>
                            <span x-show="showRawJson">Hide Raw JSON</span>
                        </button>
                        <div x-show="showRawJson" class="mt-3">
                            <pre class="bg-gray-100 p-4 rounded-lg text-xs overflow-x-auto" x-text="JSON.stringify(results.structured_data, null, 2)"></pre>
                        </div>
                    </div>
                </div>

                <!-- Raw OCR View -->
                <div x-show="activeTab === 'raw' && (results?.results || results?.ocr_results)" class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Raw OCR Results</h3>
                    <div class="bg-gray-100 p-4 rounded-lg max-h-96 overflow-y-auto">
                        <template x-for="(item, index) in (results?.results || results?.ocr_results || [])" :key="index">
                            <div class="mb-3 p-3 bg-white rounded border-l-4 border-blue-500">
                                <div class="flex justify-between items-start">
                                    <p class="text-sm text-gray-900 font-medium" x-text="item.text"></p>
                                    <span class="text-xs text-gray-500 ml-2" x-text="'Confidence: ' + Math.round((item.confidence || 0) * 100) + '%'"></span>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error Display -->
        <div x-show="error" class="bg-red-50 border border-red-200 rounded-lg p-4 fade-in">
            <div class="flex">
                <i class="fas fa-exclamation-triangle text-red-400 mr-3 mt-1"></i>
                <div>
                    <h3 class="text-sm font-medium text-red-800">Processing Error</h3>
                    <p class="mt-1 text-sm text-red-700" x-text="error"></p>
                </div>
            </div>
        </div>
    </main>

    <script>
        function documentExtractor() {
            return {
                selectedFile: null,
                documentUrl: '',
                documentPath: '',
                isDragOver: false,
                isProcessing: false,
                extractStructured: true,
                progress: 0,
                progressMessage: '',
                results: null,
                error: null,
                activeTab: 'structured',
                showRawJson: false,
                selectedDocumentIndex: 0,  // Track which document is currently selected
                // debugMode: false,  // ðŸ”§ UNCOMMENT: Enable debug mode for development and integration

                // Get current selected document for multiple documents
                getCurrentDocument() {
                    if (!this.results || !this.results.multiple_documents) {
                        return null;
                    }
                    return this.results.documents_summary?.[this.selectedDocumentIndex] || null;
                },

                // Get current structured data for the selected document
                getCurrentStructuredData() {
                    if (!this.results) return null;
                    
                    if (this.results.multiple_documents && Array.isArray(this.results.structured_data)) {
                        return this.results.structured_data[this.selectedDocumentIndex] || null;
                    } else {
                        // Single document
                        return this.results.structured_data || null;
                    }
                },

                handleFileDrop(event) {
                    this.isDragOver = false;
                    const files = event.dataTransfer.files;
                    if (files.length > 0) {
                        this.selectFile(files[0]);
                    }
                },

                handleFileSelect(event) {
                    const file = event.target.files[0];
                    if (file) {
                        this.selectFile(file);
                    }
                },

                selectFile(file) {
                    const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
                    const maxSize = 10 * 1024 * 1024; // 10MB
                    // If file selected, clear URL and path
                    this.documentUrl = '';
                    this.documentPath = '';
                    if (!allowedTypes.includes(file.type)) {
                        this.error = 'Please select a valid file type (PDF, JPG, PNG)';
                        return;
                    }
                    if (file.size > maxSize) {
                        this.error = 'File is too large (max 10MB).';
                        return;
                    }
                    this.selectedFile = file;
                    this.error = null;
                    this.results = null;
                },

                clearFile() {
                    this.selectedFile = null;
                    this.results = null;
                    this.error = null;
                    this.selectedDocumentIndex = 0;
                },

                formatFileSize(bytes) {
                    if (!bytes) return '';
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(1024));
                    return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
                },

                async processDocument() {
                    // Validation logic
                    const allowedExtensions = ['pdf', 'jpg', 'jpeg', 'png'];
                    const maxSize = 10 * 1024 * 1024; // 10MB
                    let inputTypeCount = 0;
                    if (this.selectedFile) inputTypeCount++;
                    if (this.documentUrl) inputTypeCount++;
                    if (this.documentPath) inputTypeCount++;
                    if (inputTypeCount === 0) {
                        this.error = 'Please select a file, enter a URL, or provide a file path.';
                        return;
                    }
                    if (inputTypeCount > 1) {
                        this.error = 'Please use only one input type at a time (file, URL, or path).';
                        return;
                    }
                    // File validation
                    if (this.selectedFile) {
                        const ext = this.selectedFile.name.split('.').pop().toLowerCase();
                        if (!allowedExtensions.includes(ext)) {
                            this.error = 'Unsupported file type. Allowed: PDF, JPG, JPEG, PNG.';
                            return;
                        }
                        if (this.selectedFile.size > maxSize) {
                            this.error = 'File is too large (max 10MB).';
                            return;
                        }
                    }
                    // URL validation - UPDATED to support HTTPS document URLs
                    if (this.documentUrl) {
                        // Accept any URL that looks legitimate
                        const validUrlPattern = /^https?:\/\/.+/i;
                        
                        if (!validUrlPattern.test(this.documentUrl)) {
                            this.error = 'Invalid URL format. Please provide a valid URL.';
                            return;
                        }
                        
                        console.log('URL validation passed: ' + this.documentUrl);
                    }
                    // Path validation
                    if (this.documentPath) {
                        const pathPattern = /\.(pdf|jpg|jpeg|png)$/i;
                        if (!pathPattern.test(this.documentPath)) {
                            this.error = 'Invalid file path or unsupported file type. Path must end with PDF, JPG, JPEG, or PNG.';
                            return;
                        }
                    }

                    this.isProcessing = true;
                    this.error = null;
                    this.results = null;
                    this.progress = 0;
                    this.progressMessage = 'Uploading document...';

                    try {
                        const formData = new FormData();
                        if (this.selectedFile) {
                            formData.append('file', this.selectedFile);
                        } else if (this.documentUrl) {
                            formData.append('url', this.documentUrl);
                        } else if (this.documentPath) {
                            formData.append('path', this.documentPath);
                        }

                        const endpoint = this.extractStructured ? 
                            '/api/extract?structured=true' : 
                            '/api/extract';

                        this.progress = 30;
                        this.progressMessage = 'Processing with OCR...';

                        const response = await fetch(endpoint, {
                            method: 'POST',
                            body: formData
                        });

                        this.progress = 70;
                        this.progressMessage = 'Analyzing results...';

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.detail || 'Processing failed');
                        }

                        const data = await response.json();

                        this.progress = 100;
                        this.progressMessage = 'Complete!';

                        setTimeout(() => {
                            this.results = data;
                            this.selectedDocumentIndex = 0; // Reset to first document
                            this.isProcessing = false;
                        }, 500);

                    } catch (err) {
                        this.error = err.message;
                        this.isProcessing = false;
                        this.progress = 0;
                    }
                },

                getExtractionMethodBadge(method) {
                    if (!method) return 'bg-gray-100 text-gray-800';
                    // Handle new detailed extraction methods
                    if (method.includes('OCR+LLM') || method.includes('Kimi-K2')) {
                        return 'bg-green-100 text-green-800';
                    }
                    if (method.includes('Vision LLM') || method.includes('meta-llama/llama-4-scout-17b-16e-instruct')) {
                        return 'bg-purple-100 text-purple-800';
                    }
                    // Fallback for basic methods
                    const badges = {
                        'OCR': 'bg-blue-100 text-blue-800',
                        'LLM': 'bg-yellow-100 text-yellow-800',
                        'Template': 'bg-indigo-100 text-indigo-800'
                    };
                    return badges[method] || 'bg-gray-100 text-gray-800';
                }
            }
        }
    </script>
</body>
</html>
